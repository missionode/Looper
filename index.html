<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Looper v2 - Coming Soon</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: radial-gradient(circle at center, #0a0a0a, #000000);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        text-align: center;
    }
    .logo {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #00d9ff;
    }
    h1 {
        font-size: 3rem;
        margin: 0;
    }
    p {
        max-width: 500px;
        font-size: 1.1rem;
        color: #cccccc;
    }
    button {
        background: #00d9ff;
        border: none;
        padding: 10px 20px;
        font-size: 1rem;
        margin-top: 20px;
        cursor: pointer;
        border-radius: 5px;
        color: #000;
        transition: background 0.3s;
    }
    button:hover {
        background: #00aacc;
    }
</style>
</head>
<body>

<script>
/* ================================
   Looper Framework v2.0
   ================================ */
const Looper = {
    context: {},
    templates: {},
    domRefs: {},
    varMap: {},
    events: {},

    escapeHTML(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    },

    preload(templates, vars, events = {}) {
        this.templates = templates;
        this.context = vars;
        this.domRefs = {};
        this.events = events;
        this.varMap = {};

        // Build a variable â†’ template key map
        for (let key in templates) {
            let matches = templates[key].match(/\$\.(\w+)/g) || [];
            matches.forEach(m => {
                let varName = m.slice(2);
                if (!this.varMap[varName]) this.varMap[varName] = [];
                this.varMap[varName].push(key);
            });
        }
    },

    render(root = document.body) {
        for (let key in this.templates) {
            let html = this.replaceVars(this.templates[key]);
            let wrapper = document.createElement("div");
            wrapper.setAttribute("data-template", key);
            wrapper.innerHTML = html;
            root.appendChild(wrapper);
            this.domRefs[key] = wrapper;
        }
        this.bindEvents();
    },

    rerender(changes) {
        Object.assign(this.context, changes);
        for (let varName in changes) {
            if (this.varMap[varName]) {
                this.varMap[varName].forEach(tKey => {
                    this.domRefs[tKey].innerHTML = this.replaceVars(this.templates[tKey]);
                });
            }
        }
        this.bindEvents();
    },

    replaceVars(template) {
        // Loop syntax: $.arrayName[<li>$.subVar</li>]
        return template.replace(/\$\.(\w+)\[(.*?)\]/gs, (_, arrName, loopTpl) => {
            let arr = this.context[arrName];
            if (!Array.isArray(arr)) return "";
            return arr.map(item => {
                return loopTpl.replace(/\$\.(\w+)/g, (_, v) => {
                    let val = item[v];
                    return this.isSafeHTML(val) ? val.slice(8) : this.escapeHTML(val);
                });
            }).join("");
        }).replace(/\$\.(\w+)/g, (_, v) => {
            let val = this.context[v];
            return this.isSafeHTML(val) ? val.slice(8) : this.escapeHTML(val);
        });
    },

    isSafeHTML(val) {
        return typeof val === "string" && val.startsWith("__HTML__");
    },

    bindEvents() {
        document.querySelectorAll("[data-onclick]").forEach(el => {
            let fnName = el.getAttribute("data-onclick");
            if (typeof this.events[fnName] === "function") {
                el.onclick = this.events[fnName];
            }
        });
    }
};

/* ================================
   Demo: Coming Soon Website
   ================================ */
Looper.preload(
    {
        logo: `<div class="logo">ðŸš€</div>`,
        header: `<h1>$.title</h1>`,
        body: `<p>$.description</p>`,
        menu: `<ul>$.menuItems[<li><a href='$.url'>$.label</a></li>]</ul>`,
        footer: `<button data-onclick="changeMsg">Change Message</button>`
    },
    {
        title: "Coming Soon",
        description: "Looper is a high-performance JavaScript template engine that loads designs from JSON, preloads variables, renders instantly, and re-renders only what changes â€” no page reloads.",
        menuItems: [
            { label: "Home", url: "/" },
            { label: "About", url: "/about" }
        ]
    },
    {
        changeMsg: () => {
            Looper.rerender({
                description: "ðŸš€ The future is near. Looper will change how you build fast, secure, dynamic web pages.",
                menuItems: [
                    { label: "Dashboard", url: "/dashboard" },
                    { label: "Contact", url: "/contact" }
                ]
            });
        }
    }
);

Looper.render();
</script>

</body>
</html>
