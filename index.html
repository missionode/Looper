<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Looper v3 - Coming Soon</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: radial-gradient(circle at center, #0a0a0a, #000000);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        text-align: center;
    }
    .logo {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #00d9ff;
    }
    h1 {
        font-size: 3rem;
        margin: 0;
    }
    p {
        max-width: 500px;
        font-size: 1.1rem;
        color: #cccccc;
    }
    ul {
        list-style: none;
        padding: 0;
        margin-top: 15px;
        display: flex;
        gap: 15px;
    }
    ul li a {
        text-decoration: none;
        color: #00d9ff;
        font-weight: bold;
        transition: color 0.3s;
    }
    ul li a:hover {
        color: #00aacc;
    }
    button {
        background: #00d9ff;
        border: none;
        padding: 10px 20px;
        font-size: 1rem;
        margin-top: 20px;
        cursor: pointer;
        border-radius: 5px;
        color: #000;
        transition: background 0.3s;
    }
    button:hover {
        background: #00aacc;
    }
</style>
</head>
<body>

<script>
/* ================================
   Looper Framework v3.0
   ================================ */
const Looper = {
    context: {},
    templates: {},
    domRefs: {},
    varMap: {},
    events: {},
    lastData: "",

    escapeHTML(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    },

    preload(templates, vars, events = {}) {
        this.templates = templates;
        this.context = vars;
        this.domRefs = {};
        this.events = events;
        this.varMap = {};

        // Build var â†’ template map
        for (let key in templates) {
            let matches = templates[key].match(/\$\.(\w+)/g) || [];
            matches.forEach(m => {
                let varName = m.slice(2);
                if (!this.varMap[varName]) this.varMap[varName] = [];
                this.varMap[varName].push(key);
            });
        }
    },

    render(root = document.body) {
        root.innerHTML = ""; // clear old
        for (let key in this.templates) {
            let html = this.replaceVars(this.templates[key]);
            let wrapper = document.createElement("div");
            wrapper.setAttribute("data-template", key);
            wrapper.innerHTML = html;
            root.appendChild(wrapper);
            this.domRefs[key] = wrapper;
        }
        this.bindEvents();
    },

    rerender(changes) {
        Object.assign(this.context, changes);
        for (let varName in changes) {
            if (this.varMap[varName]) {
                this.varMap[varName].forEach(tKey => {
                    this.domRefs[tKey].innerHTML = this.replaceVars(this.templates[tKey]);
                });
            }
        }
        this.bindEvents();
    },

    replaceVars(template) {
        // Loop syntax
        return template.replace(/\$\.(\w+)\[(.*?)\]/gs, (_, arrName, loopTpl) => {
            let arr = this.context[arrName];
            if (!Array.isArray(arr)) return "";
            return arr.map(item => {
                return loopTpl.replace(/\$\.(\w+)/g, (_, v) => {
                    let val = item[v];
                    return this.isSafeHTML(val) ? val.slice(8) : this.escapeHTML(val);
                });
            }).join("");
        }).replace(/\$\.(\w+)/g, (_, v) => {
            let val = this.context[v];
            return this.isSafeHTML(val) ? val.slice(8) : this.escapeHTML(val);
        });
    },

    isSafeHTML(val) {
        return typeof val === "string" && val.startsWith("__HTML__");
    },

    bindEvents() {
        document.querySelectorAll("[data-onclick]").forEach(el => {
            let fnName = el.getAttribute("data-onclick");
            if (typeof this.events[fnName] === "function") {
                el.onclick = this.events[fnName];
            }
        });
    },

    async loadFromJSON(url, pollInterval = 0) {
        const fetchData = async () => {
            try {
                const res = await fetch(url);
                const data = await res.json();
                const jsonStr = JSON.stringify(data);

                if (jsonStr !== this.lastData) {
                    this.lastData = jsonStr;
                    this.preload(data.templates, data.vars, this.events);
                    this.render();
                }
            } catch (e) {
                console.error("Looper JSON load error:", e);
            }
        };

        await fetchData();

        if (pollInterval > 0) {
            setInterval(fetchData, pollInterval);
        }
    }
};

/* ================================
   Demo: Coming Soon Website
   ================================ */
Looper.events = {
    changeMsg: () => {
        Looper.rerender({
            description: "ðŸš€ The future is near. Looper will change how you build fast, secure, dynamic web pages.",
            menuItems: [
                { label: "Dashboard", url: "/dashboard" },
                { label: "Contact", url: "/contact" }
            ]
        });
    }
};

// Load from external JSON (poll every 5s)
Looper.loadFromJSON("site.json", 5000);
</script>

</body>
</html>
